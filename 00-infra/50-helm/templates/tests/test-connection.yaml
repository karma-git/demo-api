---

apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ include "demo-api.fullname" . }}-test-connection"
data:
  check.sh: |-
    #!/bin/bash

    # set -eux

    for target in $(kubectl get svc {{ include "demo-api.fullname" . }} -o json \
      | jq -r '.spec.ports[].port'
      ); do

      curl -sX GET {{ include "demo-api.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:$target | jq
    done

---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "demo-api.fullname" . }}-test-connection-{{ randAlphaNum 10 | lower }}"
  labels:
  {{- include "demo-api.labels" . | nindent 4 }}
spec:
  template:
    metadata:
      labels:
      {{- include "demo-api.labels" . | nindent 8 }}
        helm: test-connection
      annotations:
        "helm.sh/hook": post-install
    spec:
      volumes:
        - name: script
          configMap:
            name:  "{{ include "demo-api.fullname" . }}-test-connection"
            defaultMode: 0550

      serviceAccountName: "{{ include "demo-api.fullname" . }}-test-connection"
      containers:
      - name: "{{ include "demo-api.fullname" . }}-test-connection"
        image: docker.io/karmawow/monorepo-devops-tools:3.0
        volumeMounts:
          - name: script
            mountPath: /tmp
        command:
          - sh
          - -c
          - /tmp/check.sh

      restartPolicy: Never
  backoffLimit: 2
  # ttlSecondsAfterFinished: never

---

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "{{ include "demo-api.fullname" . }}-test-connection"
  labels:
  {{- include "demo-api.labels" . | nindent 4 }}

---

apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: "{{ include "demo-api.fullname" . }}-test-connection"
  labels:
  {{- include "demo-api.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get"]
    resourceNames: ["{{ include "demo-api.fullname" . }}"]

---

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: platform-api
subjects:
  - kind: ServiceAccount
    name: "{{ include "demo-api.fullname" . }}-test-connection"
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: "{{ include "demo-api.fullname" . }}-test-connection"
  apiGroup: rbac.authorization.k8s.io
